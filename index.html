<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Totem Quest: Giant World</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #87CEEB; }
        
        /* UI LAYOUT */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        /* TOP HUD */
        #hud-top { padding: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .totem-counter { 
            background: rgba(0,0,0,0.6); color: white; padding: 15px 25px; 
            border-radius: 12px; font-weight: bold; font-size: 1.4rem; 
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 10px;
        }
        .totem-slot { 
            width: 24px; height: 24px; border-radius: 50%; border: 3px solid #555; 
            background: rgba(0,0,0,0.5); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .filled { border-color: white !important; transform: scale(1.2); box-shadow: 0 0 15px currentColor; }

        /* BOTTOM HUD */
        #hud-bottom { padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #stamina-container { 
            width: 400px; height: 24px; background: rgba(0,0,0,0.6); 
            border: 3px solid white; border-radius: 12px; overflow: hidden; 
        }
        #stamina-bar { width: 100%; height: 100%; background: #FFD700; transition: width 0.1s linear, background 0.3s; }
        #controls-hint { 
            color: rgba(255,255,255,0.9); text-shadow: 2px 2px 0px #000; 
            font-size: 1rem; font-weight: 600; letter-spacing: 1px;
        }
        
        /* OVERLAYS */
        #message-overlay {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; color: #fff; font-weight: 900; 
            text-shadow: 3px 3px 0px #000, 0 0 20px rgba(255,255,255,0.5);
            opacity: 0; transition: opacity 0.5s; text-align: center; width: 100%;
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; pointer-events: auto; z-index: 10;
        }
        h1 { font-size: 4rem; margin: 0; text-shadow: 4px 4px 0 #000; letter-spacing: 2px; }
        .instruction-box { background: rgba(0,0,0,0.5); padding: 30px; border-radius: 15px; margin: 20px; max-width: 600px; }
        button { 
            padding: 20px 50px; font-size: 2rem; background: #FF4500; color: white; 
            border: 4px solid white; cursor: pointer; border-radius: 50px; 
            font-weight: 900; transition: 0.2s; box-shadow: 0 10px 0 #b33200;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 12px 0 #b33200; }
        button:active { transform: translateY(4px); box-shadow: 0 2px 0 #b33200; }

        /* FX */
        .shaking { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>TITAN'S PEAK</h1>
        <div class="instruction-box">
            <p>A massive open world adventure. Find the 5 Ancient Totems.</p>
            <ul style="text-align: left; font-size: 1.1rem; line-height: 1.6;">
                <li><b style="color:#ff4444">Red:</b> High Peak (East). Watch the Sunrise.</li>
                <li><b style="color:#eeeeee">White:</b> High Peak (West). Survive the Seagulls.</li>
                <li><b style="color:#44ff44">Green:</b> Forest brush at the base.</li>
                <li><b style="color:#888888">Black:</b> Inside the Giant's Cave.</li>
                <li><b style="color:#4444ff">Blue:</b> Floating at the water's edge.</li>
            </ul>
        </div>
        <button id="start-btn">ENTER WORLD</button>
    </div>

    <div id="ui-layer">
        <div id="hud-top">
            <div class="totem-counter">
                <span>TOTEMS</span>
                <span id="slot-red" class="totem-slot" style="border-color:#ff4444"></span>
                <span id="slot-white" class="totem-slot" style="border-color:#eeeeee"></span>
                <span id="slot-green" class="totem-slot" style="border-color:#44ff44"></span>
                <span id="slot-black" class="totem-slot" style="border-color:#444444"></span>
                <span id="slot-blue" class="totem-slot" style="border-color:#4444ff"></span>
            </div>
            <div id="time-display" style="color: white; font-weight: 900; font-size: 1.5rem; text-shadow: 2px 2px 0 black;">12:00 PM</div>
        </div>
        <div id="message-overlay"></div>
        <div id="hud-bottom">
            <div id="stamina-container"><div id="stamina-bar"></div></div>
            <div id="controls-hint">WASD Move | SHIFT Sprint | SPACE Jump/Climb | MOUSE Look</div>
        </div>
    </div>

    <!-- Three.js Import -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- CONFIGURATION ---
        const WORLD_RADIUS = 600; // Total width 1200
        const MOUNTAIN_HEIGHT = 360;
        const WATER_LEVEL = 15;
        const CHUNK_SIZE = 100; // Size of terrain squares
        const DRAW_DISTANCE = 4; // Radius of chunks to render around player (4 = 9x9 grid roughly)
        
        const COLORS = {
            grass: 0x567d46,
            rock: 0x5a5a5a,
            snow: 0xffffff,
            sand: 0xe6c288,
            water: 0x1ca3ec,
            sky: 0x87CEEB,
            sun: 0xFDB813
        };

        // --- GAME STATE ---
        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let sprint = false, jumping = false;
        let canJump = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let prevTime = performance.now();
        
        // Player Stats
        let stamina = 100;
        const MAX_STAMINA = 100;
        let isClimbing = false;
        let collectedTotems = { red: false, white: false, green: false, black: false, blue: false };
        let playerHeight = 12;

        // Environment
        let sunLight, sunMesh;
        let dayTime = 0.5; 
        const activeChunks = new Map(); // Key: "x,z" Value: Mesh
        const totems = [];
        const birds = [];
        
        // Deterministic Noise Helper (simple pseudo random)
        function pseudorandom(x, z) {
            let n = Math.sin(x * 12.9898 + z * 78.233) * 43758.5453;
            return n - Math.floor(n);
        }

        function noise(x, z) {
            // Very simple value noise smoothing
            const floorX = Math.floor(x);
            const floorZ = Math.floor(z);
            const s = pseudorandom(floorX, floorZ); 
            const t = pseudorandom(floorX+1, floorZ);
            const u = pseudorandom(floorX, floorZ+1);
            const v = pseudorandom(floorX+1, floorZ+1);
            const fX = x - floorX;
            const fZ = z - floorZ;
            const i1 = s + (t - s) * fX;
            const i2 = u + (v - u) * fX;
            return i1 + (i2 - i1) * fZ;
        }

        // --- MATH: HEIGHT FUNCTION (The Source of Truth) ---
        function getHeight(x, z) {
            const dist = Math.sqrt(x*x + z*z);
            
            // 1. Base Mountain Shape (Large Cone)
            let h = 0;
            if (dist < WORLD_RADIUS) {
                // Parabolic falloff for nicer curve than linear
                const normalizeDist = dist / WORLD_RADIUS;
                h = MOUNTAIN_HEIGHT * Math.pow(1 - normalizeDist, 1.5);
            }
            
            // 2. Add Detail Noise (Low frequency for hills)
            h += noise(x * 0.02, z * 0.02) * 20;
            
            // 3. Add High Frequency Noise (Rocks/Roughness)
            h += noise(x * 0.1, z * 0.1) * 3;

            // 4. Cave Indentation (Specific coordinates for Black Totem)
            // Area: x[120, 200], z[50, 150]
            if (x > 120 && x < 200 && z > 50 && z < 150) {
                 // Dig a trench
                 h *= 0.3; 
                 if (h < 25) h = 25; // Flat floor
            }

            // 5. Water Bed
            if (h < WATER_LEVEL) h = WATER_LEVEL - 10; 

            return h;
        }

        init();
        animate();

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(COLORS.sky);
            scene.fog = new THREE.Fog(COLORS.sky, 50, 450); // Fog hides chunk loading edges

            camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 1000);

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambient);

            sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.castShadow = true;
            // Optimize Shadow Map for Large World
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.top = 200;
            sunLight.shadow.camera.bottom = -200;
            sunLight.shadow.camera.left = -200;
            sunLight.shadow.camera.right = 200;
            scene.add(sunLight);

            // Visual Sun
            const sunGeo = new THREE.SphereGeometry(20, 16, 16);
            sunMesh = new THREE.Mesh(sunGeo, new THREE.MeshBasicMaterial({color: COLORS.sun}));
            scene.add(sunMesh);

            // Water Plane (Infinite Visual)
            const waterGeo = new THREE.PlaneGeometry(WORLD_RADIUS * 3, WORLD_RADIUS * 3);
            waterGeo.rotateX(-Math.PI / 2);
            const waterMat = new THREE.MeshPhongMaterial({ 
                color: COLORS.water, transparent: true, opacity: 0.7, shininess: 90 
            });
            const water = new THREE.Mesh(waterGeo, waterMat);
            water.position.y = WATER_LEVEL;
            scene.add(water);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Cap pixel ratio for performance
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // Controls
            controls = new PointerLockControls(camera, document.body);
            
            // Set Start Position (Base of mountain, safe spot)
            // Searching for a spot at roughly Radius * 0.7
            const startX = -350;
            const startZ = 100;
            const startY = getHeight(startX, startZ);
            camera.position.set(startX, startY + 10, startZ);

            // Event Listeners
            setupInputs();
            setupUI();
            
            // Generate Static Objects (Cave Rocks, Trees, Totems)
            // Note: Since chunk loading only handles terrain, we'll spawn in
